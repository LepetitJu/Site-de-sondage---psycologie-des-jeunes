// helper pour r√©cup√©rer un champ qui peut avoir plusieurs cl√©s (ex: accent ou non)
function getField(obj, ...keys) {
    for (const k of keys) {
    if (obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
    }
    return '';
}

function displayResponses(responses) {
    const container = document.getElementById('responsesContainer');

    if (responses.length === 0) {
    container.innerHTML = 
        '<div class="empty"><div class="empty-icon">üì≠</div><p>Aucune r√©ponse pour le moment</p></div>';
    return;
    }

    container.innerHTML = responses.map(r => {
    const journee = getField(r, 'journ√©e_difficile', 'journee_difficile', 'journ√©eDifficile');
    const situations = getField(r, 'situations_stress', 'situations_de_stress', 'situationsStress');
    return `
    <div class="response-card">
        <div class="response-header">
        <span class="response-id">R√©ponse #${r.id}</span>
        <span class="response-date">${formatDate(r.timestamp)}</span>
        </div>
        <div class="response-grid">
        <div class="response-item">
            <div class="response-label">√Çge</div>
            <div class="response-value">${r.age ? r.age + ' ans' : '‚Äî'}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Genre</div>
            <div class="response-value">${formatGenre(r.genre)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">√âtat mental</div>
            <div class="response-value">${formatEtatMental(r.etat_mental)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Compr√©hension par la famille</div>
            <div class="response-value">${formatComprehensionFamille(r.comprehension_famille)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Isolement</div>
            <div class="response-value">${formatIsolement(r.isolement)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Anxi√©t√© intense</div>
            <div class="response-value">${formatAnxiete(r.anxiete)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Auto‚Äëmutilation / pens√©es auto‚Äëdestructrices</div>
            <div class="response-value">${formatOuiNon(r.auto_mal)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Crises de panique</div>
            <div class="response-value">${formatCrisesPanique(r.crises_panique)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Relation avec les amis</div>
            <div class="response-value">${formatRelationAmis(r.relation_amis)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Comparaison aux autres</div>
            <div class="response-value">${formatComparaison(r.comparaison)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Inqui√©tude pour l'avenir</div>
            <div class="response-value">${formatInquietudeAvenir(r.inquietude_avenir)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Harc√®lement (victime/t√©moin)</div>
            <div class="response-value">${formatOuiNon(r.harcelement)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Temps sur r√©seaux sociaux</div>
            <div class="response-value">${formatTempsReseaux(r.temps_reseaux)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Image du corps</div>
            <div class="response-value">${formatImageCorps(r.image_corps)}</div>
        </div>
        <div class="response-item">
            <div class="response-label">Consultation psy</div>
            <div class="response-value">${formatConsultation(r.consultation_psy)}</div>
        </div>
        </div>

        ${Array.isArray(r.sources_stress) && r.sources_stress.length > 0 ? `
        <div class="response-item" style="margin-top: 12px;">
            <div class="response-label">Sources de stress</div>
            <div class="response-value">
            ${r.sources_stress.map(s => `<span class="badge badge-info">${formatSourceStress(s)}</span>`).join('')}
            </div>
        </div>
        ` : ''}

        ${journee ? `
        <div class="response-item" style="margin-top: 12px;">
            <div class="response-label">Journ√©e difficile</div>
            <div class="response-value">${escapeHtml(journee)}</div>
        </div>
        ` : ''}

        ${situations ? `
        <div class="response-item" style="margin-top: 12px;">
            <div class="response-label">Situations stressantes</div>
            <div class="response-value">${escapeHtml(situations)}</div>
        </div>
        ` : ''}

        ${r.commentaires ? `
        <div class="response-item" style="margin-top: 12px;">
            <div class="response-label">Commentaires</div>
            <div class="response-value">${escapeHtml(r.commentaires)}</div>
        </div>
        ` : ''}
    </div>
    `;
    }).join('');
}

// petits helpers pour s√©curiser l'affichage (√©chapper < & > et guillemets)
function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/\n/g, '<br>');
}

// formatters pour les nouvelles questions
function formatEtatMental(v) {
    const map = { 'triste':'Triste','anxieux':'Anxieux(se)','neutre':'Neutre','heureux':'Heureux(se)' };
    return map[v] || v || 'Non renseign√©';
}
function formatComprehensionFamille(v) {
    const map = { 'oui_facilement':'Oui, facilement','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais','pas_de_parents':"Je n'ai pas de parents/tuteurs" };
    return map[v] || v || 'Non renseign√©';
}
function formatIsolement(v) {
    const map = { 'souvent':'Souvent','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' };
    return map[v] || v || 'Non renseign√©';
}
function formatAnxiete(v) { return formatIsolement(v); }
function formatOuiNon(v) { const map = { 'oui':'Oui','non':'Non' }; return map[v] || v || 'Non renseign√©'; }
function formatCrisesPanique(v) { const map = { 'souvent':'Souvent','rarement':'Rarement','jamais':'Jamais' }; return map[v] || v || 'Non renseign√©'; }
function formatRelationAmis(v) {
    const map = { 'tres_bonne':'Tr√®s bonne','bonne':'Bonne','moyenne':'Moyenne','difficile':'Difficile','tres_difficile':'Tr√®s difficile' };
    return map[v] || v || 'Non renseign√©';
}
function formatComparaison(v) { const map = { 'beaucoup':'Beaucoup','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' }; return map[v] || v || 'Non renseign√©'; }
function formatInquietudeAvenir(v) { return formatComparaison(v); }
function formatHarcelement(v) { return formatOuiNon(v); }
function formatTempsReseaux(v) { const map = { 'beaucoup':'Beaucoup','modere':'Mod√©r√©ment','peu':'Peu' }; return map[v] || v || 'Non renseign√©'; }
function formatImageCorps(v) { const map = { 'bien':'Bien','assez_bien':'Assez bien','mal':'Mal','tres_mal':'Tr√®s mal' }; return map[v] || v || 'Non renseign√©'; }

// Mettre √† jour exportCSV pour inclure les nouveaux champs
function exportCSV() {
    if (allResponses.length === 0) {
    alert('Aucune donn√©e √† exporter');
    return;
    }

    // En-t√™tes (ajout des nouvelles colonnes)
    let csv = 'ID,Date,√Çge,Genre,√âtat mental,Compr√©hension famille,Isolement,Anxi√©t√©,Auto-mutilation,Crises panique,Relation amis,Comparaison,Inqui√©tude avenir,Harc√®lement,Temps r√©seaux,Image corps,Bien-√™tre mental,Stress,Sommeil,Consultation psy,Sources de stress,Journ√©e difficile,Situations stress,Commentaires\n';

    // Donn√©es
    allResponses.forEach(r => {
    const sources = Array.isArray(r.sources_stress) ? r.sources_stress.join('; ') : '';
    const commentaires = (r.commentaires || '').replace(/"/g, '""').replace(/\n/g, ' ');
    const journee = (getField(r, 'journ√©e_difficile', 'journee_difficile') || '').replace(/"/g, '""').replace(/\n/g, ' ');
    const situations = (getField(r, 'situations_stress', 'situationsStress') || '').replace(/"/g, '""').replace(/\n/g, ' ');

    csv += `${r.id},"${formatDate(r.timestamp)}",${r.age || ''},"${formatGenre(r.genre)}","${formatEtatMental(r.etat_mental)}","${formatComprehensionFamille(r.comprehension_famille)}","${formatIsolement(r.isolement)}","${formatAnxiete(r.anxiete)}","${formatOuiNon(r.auto_mal)}","${formatCrisesPanique(r.crises_panique)}","${formatRelationAmis(r.relation_amis)}","${formatComparaison(r.comparaison)}","${formatInquietudeAvenir(r.inquietude_avenir)}","${formatHarcelement(r.harcelement)}","${formatTempsReseaux(r.temps_reseaux)}","${formatImageCorps(r.image_corps)}","${formatBienEtre(r.bien_etre_mental || r.bien_etre)}",${r.stress || ''},${r.sommeil || ''},"${formatConsultation(r.consultation_psy)}","${sources}","${journee}","${situations}","${commentaires}"\n`;
    });

    downloadFile(csv, 'sondage_resultats.csv', 'text/csv');
}
