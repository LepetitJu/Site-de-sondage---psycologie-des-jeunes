<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - R√©sultats du Sondage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f1f3f4;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #673ab7;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #673ab7;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .actions {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #673ab7;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5e35b1;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .responses-container {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        
        .responses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f3f4;
        }
        
        .responses-header h2 {
            color: #333;
        }
        
        .filter-input {
            padding: 8px 16px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }
        
        .response-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: box-shadow 0.2s;
        }
        
        .response-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .response-id {
            font-weight: bold;
            color: #673ab7;
        }
        
        .response-date {
            color: #666;
            font-size: 13px;
        }
        
        .response-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .response-item {
            padding: 8px 0;
        }
        
        .response-label {
            font-weight: 600;
            color: #555;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .response-value {
            color: #333;
            font-size: 14px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        .badge-info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        @media (max-width: 768px) {
            .filter-input {
                width: 100%;
            }
            
            .responses-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Tableau de Bord - Sondage Psychologie</h1>
            <p>G√©rez et analysez les r√©ponses de votre sondage</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalResponses">-</div>
                <div class="stat-label">R√©ponses totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgAge">-</div>
                <div class="stat-label">√Çge moyen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="etat_mental">-</div>
                <div class="stat-label">Etat mental</div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Actualiser</button>
            <button class="btn btn-success" onclick="exportCSV()">üì• Exporter en CSV</button>
            <button class="btn btn-success" onclick="exportJSON()">üì• Exporter en JSON</button>
        </div>
        
        <div class="responses-container">
            <div class="responses-header">
                <h2>R√©ponses d√©taill√©es</h2>
                <input type="text" class="filter-input" id="searchInput" placeholder="üîç Rechercher...">
            </div>
            
            <div id="responsesContainer">
                <div class="loading">Chargement des donn√©es...</div>
            </div>
        </div>
    </div>
    
    <script>
        let allResponses = [];
        
        // Charger les donn√©es au d√©marrage
        loadData();
        
        // Recherche en temps r√©el
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterResponses(e.target.value);
        });
        
        async function loadData() {
            try {
                // Charger les statistiques
                const statsRes = await fetch('/api/stats');
                const stats = await statsRes.json();
                
                document.getElementById('totalResponses').textContent = stats.total;
                document.getElementById('avgAge').textContent = stats.age_moyen;
                document.getElementById('etat_mental').textContent = stats.etat_mental;
                
                // Charger les r√©ponses
                const responsesRes = await fetch('/api/responses');
                const data = await responsesRes.json();
                allResponses = data.responses || [];
                
                displayResponses(allResponses);
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('responsesContainer').innerHTML = 
                    '<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><p>Erreur de chargement des donn√©es</p></div>';
            }
        }
        
        function displayResponses(responses) {
            const container = document.getElementById('responsesContainer');
            
            if (responses.length === 0) {
                container.innerHTML = 
                    '<div class="empty"><div class="empty-icon">üì≠</div><p>Aucune r√©ponse pour le moment</p></div>';
                return;
            }
            
            container.innerHTML = responses.map(r => `
                <div class="response-card">
                    <div class="response-header">
                        <span class="response-id">R√©ponse #${r.id}</span>
                        <span class="response-date">${formatDate(r.timestamp)}</span>
                    </div>
                    <div class="response-grid">
                        <div class="response-item">
                            <div class="response-label">√Çge</div>
                            <div class="response-value">${r.age ?? '-' } ans</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Genre</div>
                            <div class="response-value">${formatGenre(r.genre)}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Comment te sens-tu la plupart du temps ?</div>
                            <div class="response-value">${({ 'triste':'Triste','anxieux':'Anxieux(se)','neutre':'Neutre','heureux':'Heureux(se)' }[r.etat_mental] || r.etat_mental || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Te sens-tu compris(e) par tes parents/proches ?</div>
                            <div class="response-value">${({ 'oui_facilement':'Oui, facilement','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais','pas_de_parents':"Je n'ai pas de parents/tuteurs" }[r.comprehension_famille] || r.comprehension_famille || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">T‚Äôes-tu d√©j√† senti(e) seul(e) m√™me entour√©(e) ?</div>
                            <div class="response-value">${({ 'souvent':'Souvent','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' }[r.isolement] || r.isolement || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">As-tu d√©j√† ressenti de l‚Äôanxi√©t√© intense ?</div>
                            <div class="response-value">${({ 'souvent':'Souvent','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' }[r.anxiete] || r.anxiete || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">T‚Äôes-tu d√©j√† mutil√©(e) / pens√©es de te faire du mal ?</div>
                            <div class="response-value">${({ 'oui':'Oui','non':'Non' }[r.auto_mal] || r.auto_mal || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Crises de panique / forte anxi√©t√©</div>
                            <div class="response-value">${({ 'souvent':'Souvent','rarement':'Rarement','jamais':'Jamais' }[r.crises_panique] || r.crises_panique || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Relation avec tes amis</div>
                            <div class="response-value">${({ 'tres_bonne':'Tr√®s bonne','bonne':'Bonne','moyenne':'Moyenne','difficile':'Difficile','tres_difficile':'Tr√®s difficile' }[r.relation_amis] || r.relation_amis || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Te compares-tu souvent aux autres ?</div>
                            <div class="response-value">${({ 'beaucoup':'Beaucoup','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' }[r.comparaison] || r.comparaison || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">T‚Äôinqui√®tes-tu pour l‚Äôavenir ?</div>
                            <div class="response-value">${({ 'beaucoup':'Beaucoup','parfois':'Parfois','rarement':'Rarement','jamais':'Jamais' }[r.inquietude_avenir] || r.inquietude_avenir || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Victime ou t√©moin de harc√®lement ?</div>
                            <div class="response-value">${({ 'oui':'Oui','non':'Non' }[r.harcelement] || r.harcelement || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Temps pass√© sur les r√©seaux sociaux</div>
                            <div class="response-value">${({ 'beaucoup':'Beaucoup','modere':'Mod√©r√©ment','peu':'Peu' }[r.temps_reseaux] || r.temps_reseaux || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">Image de ton corps / apparence</div>
                            <div class="response-value">${({ 'bien':'Bien','assez_bien':'Assez bien','mal':'Mal','tres_mal':'Tr√®s mal' }[r.image_corps] || r.image_corps || '-')}</div>
                        </div>
                        <div class="response-item">
                            <div class="response-label">As-tu d√©j√† consult√© un professionnel (sant√© mentale) ?</div>
                            <div class="response-value">${formatConsultation(r.consultation_psy)}</div>
                        </div>
                    </div>

                    ${ ( (r['journ√©e_difficile'] || r.journee_difficile || r['journee_difficile']) ? `
                        <div class="response-item" style="margin-top: 12px;">
                            <div class="response-label">Raconte une journ√©e o√π tu t‚Äôes senti(e) vraiment mal</div>
                            <div class="response-value">${(r['journ√©e_difficile'] || r.journee_difficile || r['journee_difficile'] || '').replace(/\n/g,'<br>')}</div>
                        </div>
                    ` : '')}

                    ${ ( (r.situations_stress) ? `
                        <div class="response-item" style="margin-top: 12px;">
                            <div class="response-label">Quelles situations te rendent le plus mal √† l‚Äôaise / stress√©(e) ?</div>
                            <div class="response-value">${(r.situations_stress || '').replace(/\n/g,'<br>')}</div>
                        </div>
                    ` : '')}

                    ${ ( (r.commentaires) ? `
                        <div class="response-item" style="margin-top: 12px;">
                            <div class="response-label">Commentaires</div>
                            <div class="response-value">${(r.commentaires || '').replace(/\n/g,'<br>')}</div>
                        </div>
                    ` : '')}
                </div>
            `).join('');
        }
        
        function filterResponses(query) {
            const filtered = allResponses.filter(r => {
                const searchStr = JSON.stringify(r).toLowerCase();
                return searchStr.includes(query.toLowerCase());
            });
            displayResponses(filtered);
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'Date inconnue';
            const date = new Date(timestamp);
            return date.toLocaleString('fr-FR');
        }
        
        function formatGenre(genre) {
            const genres = {
                'homme': 'Homme',
                'femme': 'Femme',
                'non-binaire': 'Non-binaire',
                'autre': 'Autre',
                'prefere_ne_pas_repondre': 'Pr√©f√®re ne pas r√©pondre'
            };
            return genres[genre] || genre;
        }
        
        function formatConsultation(value) {
            const values = {
                'oui': 'Oui',
                'non': 'Non',
                'envisage': 'Non, mais j\'y pense'
            };
            return values[value] || value || 'Non renseign√©';
        }
        
        function refreshData() {
            document.getElementById('responsesContainer').innerHTML = 
                '<div class="loading">Actualisation...</div>';
            loadData();
        }
        
        function exportCSV() {
            if (allResponses.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            // En-t√™tes
            let csv = 'ID,Date,√Çge,Genre,Bien-√™tre mental,Stress,Sommeil,Consultation psy,Sources de stress,Commentaires\n';
            
            // Donn√©es
            allResponses.forEach(r => {
                const sources = Array.isArray(r.sources_stress) ? r.sources_stress.join('; ') : '';
                const commentaires = (r.commentaires || '').replace(/"/g, '""').replace(/\n/g, ' ');
                
                csv += `${r.id},"${formatDate(r.timestamp)}",${r.age},"${formatGenre(r.genre)}","${formatBienEtre(r.bien_etre_mental)}","${formatConsultation(r.consultation_psy)}","${sources}","${commentaires}"\n`;
            });
            
            // T√©l√©charger
            downloadFile(csv, 'sondage_resultats.csv', 'text/csv');
        }
        
        function exportJSON() {
            if (allResponses.length === 0) {
                alert('Aucune donn√©e √† exporter');
                return;
            }
            
            const json = JSON.stringify({ responses: allResponses }, null, 2);
            downloadFile(json, 'sondage_resultats.json', 'application/json');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
